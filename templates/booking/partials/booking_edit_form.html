{% load i18n %}
<form method="POST" action="{{ form_action|default:'' }}" class="booking-edit-form" data-booking-id="{{ booking.id }}" data-validate-url="{{ validate_url }}" data-logs-url="{{ logs_url }}" data-available-cabinets-url="{{ available_cabinets_url }}" data-specialists-url="{{ specialists_url }}" {% if submit_via_ajax %}data-ajax="true"{% endif %}>
    {% csrf_token %}

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
            {{ form.guest_name.label_tag }}
            {{ form.guest_name }}
            {% if form.guest_name.errors %}
                <div class="text-danger">{{ form.guest_name.errors }}</div>
            {% endif %}
        </div>
        <div class="col-12 col-md-6">
            {{ form.guest_room_number.label_tag }}
            {{ form.guest_room_number }}
            {% if form.guest_room_number.errors %}
                <div class="text-danger">{{ form.guest_room_number.errors }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
            {{ form.service_variant.label_tag }}
            {{ form.service_variant }}
            {% if form.service_variant.errors %}
                <div class="text-danger">{{ form.service_variant.errors }}</div>
            {% endif %}
        </div>
        <div class="col-12 col-md-6">
            {{ form.specialist.label_tag }}
            {{ form.specialist }}
            {% if form.specialist.errors %}
                <div class="text-danger">{{ form.specialist.errors }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
            {{ form.start_datetime.label_tag }}
            {{ form.start_datetime }}
            {% if form.start_datetime.errors %}
                <div class="text-danger">{{ form.start_datetime.errors }}</div>
            {% endif %}
            <div data-role="start-validation" class="mt-1"></div>
        </div>
        <div class="col-12 col-md-6">
            {{ form.cabinet.label_tag }}
            {{ form.cabinet }}
            <div class="form-text text-muted" data-role="cabinet-help" data-default-text="{% trans "Будет выбран автоматически, если доступен" %}">{% trans "Будет выбран автоматически, если доступен" %}</div>
            {% if form.cabinet.errors %}
                <div class="text-danger">{{ form.cabinet.errors }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
            {{ form.status.label_tag }}
            {{ form.status }}
            {% if form.status.errors %}
                <div class="text-danger">{{ form.status.errors }}</div>
            {% endif %}
        </div>
    </div>

    <div class="card border-warning-subtle mt-4" data-role="recurrence-card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <div class="d-flex align-items-center gap-2">
                    <h6 class="mb-0"><i class="bi bi-arrow-repeat me-2 text-warning"></i>{% trans "Повтор бронирования" %}</h6>
                    {% if series %}
                    <span class="badge bg-warning text-dark">{% trans "Серия" %}: {{ series_count }}</span>
                    {% endif %}
                </div>
                <div class="form-check form-switch m-0">
                    {{ form.recurrence_enabled }}
                    <label class="form-check-label ms-2" for="{{ form.recurrence_enabled.id_for_label }}">{% trans "Включить повтор" %}</label>
                </div>
            </div>
            {% if form.recurrence_enabled.errors %}
            <div class="text-danger mb-2 small">{{ form.recurrence_enabled.errors }}</div>
            {% endif %}
            <div class="recurrence-settings {% if not form.recurrence_enabled.value %}d-none{% endif %}" data-role="recurrence-settings">
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.recurrence_frequency.id_for_label }}">{% trans "Частота" %}</label>
                        {{ form.recurrence_frequency }}
                        {% if form.recurrence_frequency.errors %}
                        <div class="text-danger small mt-1">{{ form.recurrence_frequency.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.recurrence_interval.id_for_label }}">{% trans "Каждые" %}</label>
                        <div class="input-group">
                            {{ form.recurrence_interval }}
                            <span class="input-group-text" data-role="recurrence-interval-label">{% trans "дней" %}</span>
                        </div>
                        {% if form.recurrence_interval.errors %}
                        <div class="text-danger small mt-1">{{ form.recurrence_interval.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3 {% if form.recurrence_frequency.value != 'weekly' %}d-none{% endif %}" data-role="recurrence-weekdays">
                    <label class="form-label d-block">{% trans "Повторять по дням недели" %}</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for checkbox in form.recurrence_weekdays %}
                        <div class="form-check">
                            {{ checkbox.tag }}
                            <label class="form-check-label ms-1" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.recurrence_weekdays.errors %}
                    <div class="text-danger small mt-1">{{ form.recurrence_weekdays.errors }}</div>
                    {% endif %}
                </div>

                <div class="row g-3 mb-3 align-items-end">
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.recurrence_end_type.id_for_label }}">{% trans "Завершить" %}</label>
                        {{ form.recurrence_end_type }}
                        {% if form.recurrence_end_type.errors %}
                        <div class="text-danger small mt-1">{{ form.recurrence_end_type.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6" data-role="recurrence-count-field">
                        <label class="form-label" for="{{ form.recurrence_occurrences.id_for_label }}">{% trans "Количество повторов" %}</label>
                        {{ form.recurrence_occurrences }}
                        {% if form.recurrence_occurrences.errors %}
                        <div class="text-danger small mt-1">{{ form.recurrence_occurrences.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6 d-none" data-role="recurrence-until-field">
                        <label class="form-label" for="{{ form.recurrence_end_date.id_for_label }}">{% trans "Дата окончания" %}</label>
                        {{ form.recurrence_end_date }}
                        {% if form.recurrence_end_date.errors %}
                        <div class="text-danger small mt-1">{{ form.recurrence_end_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="recurrenceExcludedDisplay">{% trans "Пропустить даты" %}</label>
                    <input type="text" class="form-control" id="recurrenceExcludedDisplay" data-role="recurrence-excluded-display" placeholder="{% trans "Например: 20.11.2025, 25.11.2025" %}">
                    {{ form.recurrence_excluded_dates }}
                    <div class="form-text text-muted">{% trans "Введите даты через запятую. Используйте формат ДД.ММ.ГГГГ." %}</div>
                    {% if form.recurrence_excluded_dates.errors %}
                    <div class="text-danger small mt-1">{{ form.recurrence_excluded_dates.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if form.apply_scope.is_hidden %}
        {{ form.apply_scope }}
    {% else %}
    <div class="mt-4" data-role="apply-scope">
        <label class="form-label d-block mb-2">{% trans "Применить изменения" %}</label>
        <div class="d-flex flex-column gap-2">
            {% for choice in form.apply_scope %}
            <div class="form-check">
                {{ choice.tag }}
                <label class="form-check-label ms-1" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
            </div>
            {% endfor %}
        </div>
        {% if form.apply_scope.errors %}
        <div class="text-danger small mt-1">{{ form.apply_scope.errors }}</div>
        {% endif %}
    </div>
    {% endif %}

    <div data-role="validation-message" class="alert d-none mb-3"></div>

    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3 mt-md-4">
        {% if show_back_button %}
        <a href="{{ back_url|default:calendar_url }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">{% trans "Назад к календарю" %}</span><span class="d-sm-none">{% trans "Назад" %}</span>
        </a>
        {% endif %}
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> <span class="d-none d-sm-inline">{% trans "Сохранить изменения" %}</span><span class="d-sm-none">{% trans "Сохранить" %}</span>
        </button>
    </div>

    {% if show_delete_button and delete_url %}
    <div class="alert alert-danger mt-4 mb-0" role="alert">
        <h5 class="h6 mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>{% trans "Опасные действия" %}</h5>
        <p class="mb-3 small">{% trans "Удаление бронирования нельзя отменить." %}</p>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
            <a href="{{ delete_url }}" class="btn btn-danger">
                <i class="bi bi-trash"></i> <span class="d-none d-sm-inline">{% trans "Удалить бронирование" %}</span><span class="d-sm-none">{% trans "Удалить" %}</span>
            </a>
        </div>
    </div>
    {% endif %}

    {% if logs_url %}
    <div class="card border-info-subtle mt-4" data-role="booking-logs-card">
        <div class="card-header bg-info-subtle">
            <button class="btn btn-link text-decoration-none text-dark w-100 text-start p-0 d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#bookingLogsCollapse" aria-expanded="false" aria-controls="bookingLogsCollapse">
                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>{% trans "История изменений" %}</h6>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-info" data-role="refresh-logs" title="{% trans 'Обновить' %}" onclick="event.stopPropagation();">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </button>
        </div>
        <div class="collapse" id="bookingLogsCollapse">
            <div class="card-body" data-role="booking-logs-body">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-info" role="status">
                        <span class="visually-hidden">{% trans "Загрузка..." %}</span>
                    </div>
                    <p class="text-muted small mt-2 mb-0">{% trans "Загрузка истории..." %}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</form>
