# Безопасный деплой с автоматическим бэкапом

## Описание

Система безопасного деплоя для production сервера с автоматическим созданием бэкапов БД, проверками до и после деплоя, и процедурой автоматического отката при ошибках.

## Основные возможности

- **Автоматический бэкап БД** перед каждым деплоем
- **Проверка целостности бэкапа** после создания
- **Проверки перед деплоем** (статус сервисов, доступность БД, свободное место)
- **Проверки после деплоя** (HTTP health checks, статус контейнеров, логи)
- **Автоматический откат** при критических ошибках
- **Детальное логирование** всех действий
- **Режимы работы**: автоматический, интерактивный, dry-run

## Быстрый старт

### Локальный деплой на сервере

```bash
# Базовый безопасный деплой
make deploy-safe

# С подтверждением каждого шага
make deploy-safe-interactive

# Проверка без реального деплоя
make deploy-safe-dry
```

### Удаленный деплой через SSH

```bash
# Деплой на удаленный сервер
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=root@188.166.240.56
```

### Проверка работоспособности

```bash
# Базовая проверка
make health-check

# Подробная проверка
make health-check-verbose
```

## Детальное описание

### Скрипт безопасного деплоя (`scripts/deploy_safe.sh`)

Основной скрипт, который выполняет все фазы деплоя:

#### Фаза 1: Подготовка (Pre-deployment)

1. **Проверка команд** - наличие Docker, Git
2. **Проверка Docker Compose** - доступность
3. **Проверка свободного места** - минимум 1GB
4. **Проверка статуса контейнеров** - все должны быть запущены
5. **Проверка Git** - наличие изменений для деплоя
6. **Проверка переменных окружения** - наличие .env файла

#### Фаза 2: Создание бэкапа

1. **Проверка доступности БД** - контейнер должен быть запущен
2. **Создание бэкапа** - pg_dump с сжатием gzip
3. **Проверка целостности** - размер файла, проверка архива
4. **Сохранение пути к бэкапу** - для возможного отката

#### Фаза 3: Деплой

1. **Обновление кода** - git pull origin main
2. **Сборка образа** - docker compose build web
3. **Применение миграций** - python manage.py migrate
   - **Примечание**: При первом обновлении после добавления модели Guest будет применена миграция `0011_add_guest_model.py`
   - Миграция может занять несколько минут на больших БД (зависит от количества бронирований)
   - Скрипт автоматически создает бэкап БД перед применением миграций (см. Фаза 2)
4. **Сбор статических файлов** - collectstatic
5. **Перезапуск контейнеров** - docker compose up -d
6. **Ожидание готовности** - пауза 5 секунд

#### Фаза 4: Проверка после деплоя

1. **Статус контейнеров** - все должны быть "Up"
2. **HTTP health check** - curl к главной странице
3. **Проверка подключения к БД** - django check --database
4. **Проверка миграций** - все должны быть применены
5. **Проверка результатов миграции Guest** (если применялась):
   - Количество созданных записей Guest
   - Количество бронирований, связанных с Guest
   - Скрипт автоматически проверяет результаты миграции
6. **Проверка логов** - отсутствие критических ошибок
7. **Проверка статических файлов** - наличие файлов

#### Фаза 5: Откат (при ошибках)

1. **Откат кода** - git checkout к предыдущему commit
2. **Восстановление БД** - из созданного бэкапа
3. **Перезапуск контейнеров** - восстановление рабочего состояния

### Опции скрипта

```bash
./scripts/deploy_safe.sh [--dry-run] [--interactive] [--skip-backup]
```

- `--dry-run` - проверка без реального деплоя
- `--interactive` - подтверждение каждого шага
- `--skip-backup` - пропустить создание бэкапа (не рекомендуется)

## Сценарии использования

### Сценарий 1: Успешный деплой

```bash
make deploy-safe
```

**Процесс:**
1. Выполняются все проверки перед деплоем
2. Создается бэкап БД
3. Выполняется деплой
4. Проверяется работоспособность
5. Деплой завершается успешно

**Результат:** Приложение обновлено, бэкап сохранен, все проверки пройдены.

### Сценарий 2: Ошибка при создании бэкапа

```bash
make deploy-safe
```

**Процесс:**
1. Попытка создать бэкап
2. Ошибка создания (например, БД недоступна)
3. Повторная попытка
4. Если не удалось - запрос подтверждения

**Результат:** 
- При подтверждении - деплой продолжается без бэкапа (с предупреждением)
- При отказе - деплой отменяется

### Сценарий 3: Ошибка при миграциях

```bash
make deploy-safe
```

**Процесс:**
1. Деплой начат, код обновлен
2. Ошибка при применении миграций
3. Автоматический откат:
   - Восстановление БД из бэкапа
   - Откат кода к предыдущей версии
   - Перезапуск контейнеров

**Результат:** Система возвращена к рабочему состоянию, деплой отменен.

### Сценарий 4: Контейнеры не запустились после деплоя

```bash
make deploy-safe
```

**Процесс:**
1. Деплой выполнен
2. Проверка показывает, что контейнеры не работают
3. Автоматический откат
4. Уведомление об ошибке

**Результат:** Система откачена, требуется ручное вмешательство для исправления проблемы.

### Сценарий 5: Ошибка HTTP health check

```bash
make deploy-safe
```

**Процесс:**
1. Деплой выполнен
2. Контейнеры запущены
3. HTTP запрос возвращает ошибку
4. Проверка логов
5. Запрос подтверждения на откат

**Результат:** 
- При подтверждении - выполняется откат
- При отказе - деплой считается успешным, но требуется проверка

### Сценарий 6: Проверка перед деплоем (dry-run)

```bash
make deploy-safe-dry
```

**Процесс:**
1. Выполняются все проверки
2. Симуляция создания бэкапа
3. Симуляция деплоя
4. Проверки после деплоя (на текущем состоянии)

**Результат:** Отчет о том, что будет сделано при реальном деплое, без изменений.

## Дополнительные скрипты

### Скрипт бэкапа БД (`scripts/backup_db.sh`)

Улучшенный скрипт создания бэкапа с проверкой целостности:

```bash
# Базовое использование
./scripts/backup_db.sh

# С проверкой целостности
./scripts/backup_db.sh --verify

# С удалением старых бэкапов (старше 30 дней)
./scripts/backup_db.sh --keep-days=30
```

**Особенности:**
- Проверка доступности БД
- Проверка размера бэкапа
- Проверка целостности архива (опционально)
- Автоматическое удаление старых бэкапов

### Скрипт восстановления БД (`scripts/restore_db.sh`)

Безопасное восстановление из бэкапа:

```bash
# Интерактивное восстановление
./scripts/restore_db.sh backups/db_20240123_120000.sql.gz

# Без подтверждения (опасно!)
./scripts/restore_db.sh backups/db_20240123_120000.sql.gz --confirm
```

**Особенности:**
- Проверка целостности бэкапа перед восстановлением
- Создание бэкапа текущего состояния перед восстановлением
- Подтверждение перед восстановлением
- Проверка результата восстановления

### Скрипт проверки работоспособности (`scripts/health_check.sh`)

Комплексная проверка состояния приложения:

```bash
# Базовая проверка
./scripts/health_check.sh

# Подробная проверка
./scripts/health_check.sh --verbose
```

**Проверяет:**
- Доступность Docker и Docker Compose
- Статус всех контейнеров
- Доступность базы данных
- Подключение к БД
- Статус миграций
- HTTP доступность
- Статические файлы
- Логи на ошибки

### Скрипт удаленного деплоя (`scripts/deploy_remote.sh`)

Деплой на удаленный сервер через SSH:

```bash
# Базовое использование
./scripts/deploy_remote.sh ~/.ssh/id_rsa root@188.166.240.56

# С проверкой (dry-run)
./scripts/deploy_remote.sh ~/.ssh/id_rsa root@188.166.240.56 --dry-run

# Интерактивный режим
./scripts/deploy_remote.sh ~/.ssh/id_rsa root@188.166.240.56 --interactive
```

**Особенности:**
- Автоматический поиск проекта на сервере
- Копирование скрипта деплоя при необходимости
- Выполнение безопасного деплоя на сервере
- Проверка работоспособности после деплоя

## Логирование

Все действия логируются в файл:

```
logs/deploy_YYYYMMDD_HHMMSS.log
```

Лог содержит:
- Временные метки всех действий
- Уровни сообщений (INFO, SUCCESS, WARNING, ERROR)
- Детальную информацию об ошибках
- Пути к бэкапам
- Commit hash до и после деплоя

## Безопасность

### Защита данных

- **Автоматический бэкап** перед каждым деплоем
- **Проверка целостности** бэкапа после создания
- **Хранение нескольких версий** бэкапов
- **Создание бэкапа** перед восстановлением

### Защита от ошибок

- **Проверки на каждом этапе** - остановка при ошибках
- **Автоматический откат** при критических ошибках
- **Сохранение состояния** перед изменениями
- **Детальное логирование** для анализа

### Рекомендации

1. **Всегда используйте `deploy-safe`** вместо обычного `deploy`
2. **Проверяйте логи** после каждого деплоя
3. **Храните бэкапы** в безопасном месте
4. **Тестируйте деплой** в dry-run режиме перед production
5. **Используйте интерактивный режим** для критических деплоев

## Troubleshooting

### Проблема: Бэкап не создается

**Причины:**
- Контейнер БД не запущен
- Недостаточно места на диске
- Проблемы с правами доступа

**Решение:**
```bash
# Проверка статуса контейнера
docker compose ps db

# Проверка свободного места
df -h

# Проверка прав доступа
ls -la backups/
```

### Проблема: Ошибка при миграциях

**Причины:**
- Конфликтующие миграции
- Проблемы с БД
- Несовместимость версий

**Решение:**
1. Проверьте логи: `docker compose logs web`
2. Проверьте миграции: `docker compose exec web python manage.py showmigrations`
3. При необходимости выполните откат

### Проблема: Контейнеры не запускаются

**Причины:**
- Ошибки в коде
- Проблемы с зависимостями
- Ошибки конфигурации

**Решение:**
1. Проверьте логи: `docker compose logs`
2. Проверьте конфигурацию: `docker compose config`
3. Выполните откат: скрипт автоматически откатит при ошибках

### Проблема: HTTP health check не проходит

**Причины:**
- Nginx не запущен
- Проблемы с конфигурацией
- Проблемы с SSL

**Решение:**
```bash
# Проверка Nginx
docker compose ps nginx
docker compose logs nginx

# Проверка конфигурации
docker compose exec nginx nginx -t
```

## Интеграция с существующими командами

Новые команды интегрированы с существующими:

```bash
# Старые команды (все еще работают)
make backup
make restore FILE=backups/db_xxx.sql.gz
make deploy

# Новые безопасные команды (рекомендуется)
make backup-safe
make restore-safe FILE=backups/db_xxx.sql.gz
make deploy-safe
```

## История деплоев

Информация о каждом деплое сохраняется в:
- Лог файлы: `logs/deploy_*.log`
- Бэкапы БД: `backups/db_*.sql.gz`

Для просмотра истории:
```bash
# Список логов деплоев
ls -lth logs/deploy_*.log

# Список бэкапов
ls -lth backups/db_*.sql.gz
```

## Примеры использования

### Пример 1: Стандартный деплой

```bash
# 1. Проверка перед деплоем
make deploy-safe-dry

# 2. Выполнение деплоя
make deploy-safe

# 3. Проверка работоспособности
make health-check
```

### Пример 2: Критический деплой с подтверждением

```bash
# Интерактивный режим с подтверждением каждого шага
make deploy-safe-interactive
```

### Пример 3: Удаленный деплой

```bash
# Деплой на production сервер
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=root@188.166.240.56
```

### Пример 4: Восстановление из бэкапа

```bash
# Создание бэкапа перед восстановлением
make backup-safe

# Восстановление
make restore-safe FILE=backups/db_20240123_120000.sql.gz
```

## Дополнительная информация

- [Инструкция по сбору информации о сервере](DEPLOY_SERVER_INFO.md)
- [Документация по Docker деплою](DOCKER_DEPLOYMENT.md)
- [Общая документация по деплою](DEPLOYMENT.md)

---

**Важно:** Всегда используйте `deploy-safe` для production деплоев. Это гарантирует создание бэкапа и возможность отката при ошибках.
