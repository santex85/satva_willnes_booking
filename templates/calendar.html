{% extends 'base.html' %}

{% block title %}Календарь бронирований{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
<style>
    .calendar-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem 2rem;
        transition: max-width 0.3s ease, padding 0.3s ease;
    }
    .calendar-page.calendar-wide {
        max-width: calc(100vw - 2rem);
        padding-left: 1rem;
        padding-right: 1rem;
    }
    .calendar-page.calendar-fullscreen {
        max-width: 100vw;
        width: 100vw;
        margin-left: calc((100vw - 100%) / -2);
        margin-right: calc((100vw - 100%) / -2);
        padding-left: 1rem;
        padding-right: 1rem;
    }
    @media (min-width: 1400px) {
        .calendar-page:not(.calendar-wide):not(.calendar-fullscreen) {
            max-width: 1400px;
        }
    }
    #calendar {
        width: 100%;
        margin: 0 auto;
    }
    .fc-event-title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .fc-daygrid-day:hover,
    .fc-timegrid-slot:hover {
        cursor: pointer;
    }
    .fc .fc-timegrid-now-indicator-line,
    .fc .fc-daygrid-now-indicator-line {
        border-top: 2px solid #ff4d4f;
    }
    .fc .fc-timegrid-now-indicator-arrow {
        border-color: transparent transparent #ff4d4f transparent;
    }
    .fc .fc-daygrid-now-indicator-dot {
        background: #ff4d4f;
        border-color: #ff4d4f;
    }
    .cabinet-closure-event {
        background-color: #adb5bd !important;
        border-color: #6c757d !important;
        color: #212529 !important;
        opacity: 0.85;
    }
    .legend {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid;
        flex-shrink: 0;
    }
    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .fc-header-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .fc-button-group {
            width: 100%;
            display: flex;
        }
        .fc-button {
            flex: 1;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .fc-today-button {
            width: 100%;
        }
        .fc-prev-button, .fc-next-button {
            flex: 0 0 auto;
        }
        .legend {
            gap: 0.5rem;
            padding: 0.5rem;
        }
        .legend-item {
            font-size: 0.75rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
        }
        .btn-group {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 80px;
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
        }
    }
    /* Улучшение модальных окон для мобильных */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        .modal-content {
            border-radius: 0.5rem;
        }
    }
</style>
{% endblock %}

{% load static %}
{% block content %}
<div id="calendar-page" class="calendar-page" 
     data-can-manage-closures="{{ can_manage_closures|yesno:'true,false' }}" 
     data-copy-shortcuts-enabled="{{ copy_shortcuts_enabled|yesno:'true,false' }}"
     data-closure-feed-url="{% url 'calendar_closure_feed' %}"
     data-closure-create-url="{% url 'create_cabinet_closure' %}"
     data-duplicate-booking-url="{% url 'duplicate_booking' %}">
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
    <h1 class="h3 mb-2 mb-md-0"><i class="bi bi-calendar-week"></i> Календарь бронирований</h1>
    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
        <button type="button" id="toggle-width-btn" class="btn btn-outline-secondary flex-fill flex-sm-grow-0" onclick="toggleCalendarWidth()">
            <i class="bi bi-arrows-expand"></i> Широкий режим
        </button>
        {% if can_manage_closures %}
        <button type="button" class="btn btn-outline-danger flex-fill flex-sm-grow-0" id="open-closure-modal-btn" onclick="openCabinetClosureModal()">
            <i class="bi bi-door-closed"></i> Закрыть кабинет
        </button>
        {% endif %}
        <a href="{% url 'select_service' %}" class="btn btn-primary flex-fill flex-sm-grow-0">
            <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">Создать бронирование</span><span class="d-sm-none">Создать</span>
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-3 mb-3">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="btn-group" role="group" aria-label="Навигация по календарю">
                    <button type="button" class="btn btn-outline-secondary" id="calendar-prev-btn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="calendar-today-btn">
                        Сегодня
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="calendar-next-btn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div id="calendar-current-range" class="fw-semibold text-nowrap"></div>
            </div>
            <div class="btn-group w-100 w-xl-auto" role="group">
                <button type="button" class="btn btn-outline-primary" data-view-switch="dayGridMonth" onclick="switchView('dayGridMonth')">
                    <i class="bi bi-calendar3"></i> <span class="d-none d-sm-inline">Месяц</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridWeek" onclick="switchView('timeGridWeek')">
                    <i class="bi bi-grid-3x3"></i> <span class="d-none d-sm-inline">Неделя</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridThreeDay" onclick="switchView('timeGridThreeDay')">
                    <i class="bi bi-calendar-range"></i> <span class="d-none d-sm-inline">3 дня</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridDay" onclick="switchView('timeGridDay')">
                    <i class="bi bi-calendar-day"></i> <span class="d-none d-sm-inline">День</span>
                </button>
            </div>

        </div>

        <!-- Легенда кабинетов -->
        <div class="legend">
            {% for item in cabinets_with_colors %}
            <div class="legend-item">
                <div class="legend-color" style="background-color: {{ item.bg_color }}; border-color: {{ item.border_color }};"></div>
                <span>{{ item.cabinet.name }}</span>
            </div>
            {% endfor %}
            <div class="legend-item">
                <div class="legend-color" style="background-color: #adb5bd; border-color: #6c757d;"></div>
                <span>Кабинет закрыт</span>
            </div>
        </div>

        <div id="calendar"></div>
    </div>
</div>
</div>

<!-- Модальное окно для быстрого создания бронирования -->
<div class="modal fade" id="quickBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Создать бронирование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickBookingForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-calendar3"></i> Дата и время: <strong id="selectedDateTime"></strong>
                    </div>

                    <div class="mb-3">
                        <label for="service_variant" class="form-label">Услуга *</label>
                        <select class="form-select" id="service_variant" name="service_variant" required>
                            <option value="">Выберите услугу</option>
                            {% for group in service_groups %}
                            <optgroup label="{{ group.label }}">
                                {% for service in group.variants %}
                                <option value="{{ service.id }}">{{ service.service.name }} - {{ service.name_suffix }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="specialist" class="form-label">Специалист *</label>
                        <select class="form-select" id="specialist" name="specialist" required>
                            <option value="">Сначала выберите услугу</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cabinet" class="form-label">Кабинет</label>
                        <select class="form-select" id="cabinet" name="cabinet">
                            <option value="">Сначала выберите услугу, специалиста и время</option>
                        </select>
                        <small class="form-text text-muted">Будет выбран автоматически, если не указан</small>
                    </div>

                    <div class="mb-3">
                        <label for="guest_name" class="form-label">Имя гостя *</label>
                        <input type="text" class="form-control" id="guest_name" name="guest_name" required>
                    </div>

                    <div class="mb-3">
                        <label for="guest_room_number" class="form-label">Номер комнаты</label>
                        <input type="text" class="form-control" id="guest_room_number" name="guest_room_number">
                    </div>

                    <div class="card border-warning-subtle mb-3" data-role="quick-recurrence-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                <h6 class="mb-0"><i class="bi bi-arrow-repeat me-2 text-warning"></i>Повтор бронирования</h6>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input" type="checkbox" id="quick_recurrence_enabled" name="recurrence_enabled">
                                    <label class="form-check-label ms-2" for="quick_recurrence_enabled">Включить повтор</label>
                                </div>
                            </div>
                            <div class="recurrence-settings d-none" data-role="quick-recurrence-settings">
                                <div class="row g-3 mb-3">
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_frequency">Частота</label>
                                        <select class="form-select" id="quick_recurrence_frequency" name="recurrence_frequency">
                                            {% for value, label in quick_form.recurrence_frequency.field.choices %}
                                            <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_interval">Каждые</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="quick_recurrence_interval" name="recurrence_interval" min="1" value="1">
                                            <span class="input-group-text" data-role="quick-recurrence-interval-label">дней</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 d-none" data-role="quick-recurrence-weekdays">
                                    <label class="form-label d-block">Повторять по дням недели</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for value, label in quick_form.recurrence_weekdays.field.choices %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="quick_weekday_{{ value }}" name="recurrence_weekdays" value="{{ value }}">
                                            <label class="form-check-label ms-1" for="quick_weekday_{{ value }}">{{ label }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="row g-3 mb-3 align-items-end">
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_end_type">Завершить</label>
                                        <select class="form-select" id="quick_recurrence_end_type" name="recurrence_end_type">
                                            {% for value, label in quick_form.recurrence_end_type.field.choices %}
                                            <option value="{{ value }}" {% if quick_form.recurrence_end_type.field.initial == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6" data-role="quick-recurrence-count-field">
                                        <label class="form-label" for="quick_recurrence_occurrences">Количество повторов</label>
                                        <input type="number" class="form-control" id="quick_recurrence_occurrences" name="recurrence_occurrences" min="2" value="2">
                                    </div>
                                    <div class="col-12 col-md-6 d-none" data-role="quick-recurrence-until-field">
                                        <label class="form-label" for="quick_recurrence_end_date">Дата окончания</label>
                                        <input type="date" class="form-control" id="quick_recurrence_end_date" name="recurrence_end_date">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="quick_recurrence_excluded_display">Пропустить даты</label>
                                    <input type="text" class="form-control" id="quick_recurrence_excluded_display" data-role="quick-recurrence-excluded-display" placeholder="Например: 20.11.2025, 25.11.2025">
                                    <input type="hidden" id="quick_recurrence_excluded_dates" name="recurrence_excluded_dates">
                                    <div class="form-text text-muted">Введите даты через запятую. Используйте формат ДД.ММ.ГГГГ.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="start_datetime" name="start_datetime" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="quick-booking-cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Создать
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if closure_form %}
<!-- Модальное окно для закрытия кабинета -->
<div class="modal fade" id="cabinetClosureModal" tabindex="-1" aria-labelledby="cabinetClosureModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cabinetClosureModalLabel"><i class="bi bi-door-closed"></i> Закрыть кабинет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cabinetClosureForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-danger d-none" data-role="closure-error-non-field"></div>
                    <div class="mb-3">
                        <label class="form-label" for="{{ closure_form.cabinet.id_for_label }}">Кабинет</label>
                        {{ closure_form.cabinet }}
                        <div class="text-danger small mt-1 d-none" data-role="closure-error-cabinet"></div>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label" for="{{ closure_form.start_time.id_for_label }}">Начало</label>
                            {{ closure_form.start_time }}
                            <div class="text-danger small mt-1 d-none" data-role="closure-error-start"></div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label" for="{{ closure_form.end_time.id_for_label }}">Окончание</label>
                            {{ closure_form.end_time }}
                            <div class="text-danger small mt-1 d-none" data-role="closure-error-end"></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label" for="{{ closure_form.reason.id_for_label }}">Причина (опционально)</label>
                        {{ closure_form.reason }}
                        <div class="text-danger small mt-1 d-none" data-role="closure-error-reason"></div>
                        <div class="form-text">Кратко опишите причину закрытия (например, техобслуживание).</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-door-closed-fill"></i> Закрыть
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления закрытия -->
<div class="modal fade" id="closureDeleteModal" tabindex="-1" aria-labelledby="closureDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="closureDeleteModalLabel"><i class="bi bi-exclamation-triangle"></i> Удалить закрытие кабинета?</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Вы уверены, что хотите отменить закрытие кабинета <strong id="closureDeleteCabinetName"></strong>?</p>
                <small class="text-muted" id="closureDeletePeriod"></small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmClosureDeleteBtn">
                    <i class="bi bi-trash"></i> Удалить
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно для результатов -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="resultHeader">
                <h5 class="modal-title" id="resultTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования бронирования -->
<div class="modal fade" id="bookingEditModal" tabindex="-1" aria-labelledby="bookingEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingEditModalLabel"><i class="bi bi-pencil-square"></i> Редактировать бронирование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bookingEditModalBody">
                <div class="text-center py-5" id="bookingEditModalLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3 text-muted">Загружаем данные бронирования…</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% include 'booking/partials/booking_edit_form_script.html' %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales/ru.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ru.js"></script>
<script src="{% static 'js/calendar.js' %}"></script>
{% endblock %}

