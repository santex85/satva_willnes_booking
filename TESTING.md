# Руководство по тестированию скриптов деплоя

## Быстрый старт

### Самый безопасный способ - автоматическое тестирование

```bash
# Базовое тестирование (проверка синтаксиса и структуры)
make test-deploy

# Полное тестирование (включая проверку функций)
make test-deploy-full
```

### Быстрая проверка перед первым использованием

```bash
# 1. Автоматическая проверка (30 сек)
make test-deploy

# 2. Dry-run (1 мин)
make deploy-safe-dry

# 3. Проверка работоспособности (30 сек)
make health-check

# Если все прошло успешно - можно использовать!
```

## Уровни тестирования

### Уровень 1: Проверка синтаксиса (Безопасно - без изменений)

Проверка синтаксиса всех скриптов:

```bash
# Проверка всех скриптов
for script in scripts/*.sh; do
    echo "Проверка $script..."
    bash -n "$script" && echo "✓ OK" || echo "✗ Ошибка"
done
```

**Результат:** Убедитесь, что все скрипты имеют корректный синтаксис.

### Уровень 2: Dry-run режим (Безопасно - без изменений)

Тестирование логики скриптов без реальных изменений:

```bash
# Тест безопасного деплоя в режиме проверки
make deploy-safe-dry

# Или напрямую
./scripts/deploy_safe.sh --dry-run
```

**Что проверяется:**
- Все проверки перед деплоем
- Логика создания бэкапа (без реального создания)
- Логика деплоя (без реальных изменений)
- Проверки после деплоя (на текущем состоянии)

**Результат:** Вы увидите, что будет сделано при реальном деплое, без изменений.

### Уровень 3: Тестирование отдельных компонентов

#### 3.1. Тест скрипта бэкапа

```bash
# Создание тестового бэкапа (безопасно)
./scripts/backup_db.sh --verify

# Проверка результата
ls -lh backups/
gunzip -t backups/db_*.sql.gz  # Проверка целостности
```

**Что проверяется:**
- Создание бэкапа
- Проверка целостности
- Размер файла

#### 3.2. Тест скрипта проверки работоспособности

```bash
# Проверка текущего состояния (безопасно)
make health-check

# Подробная проверка
make health-check-verbose
```

**Что проверяется:**
- Статус контейнеров
- Доступность БД
- HTTP доступность
- Миграции
- Логи

#### 3.3. Тест скрипта восстановления (ОСТОРОЖНО!)

**ВАЖНО:** Тестируйте только на тестовой БД или с бэкапом текущего состояния!

```bash
# 1. Сначала создайте бэкап текущего состояния
make backup-safe

# 2. Запомните имя файла бэкапа
BACKUP_FILE=$(ls -t backups/db_*.sql.gz | head -1)
echo "Бэкап: $BACKUP_FILE"

# 3. Тест восстановления (только если вы готовы восстановить БД!)
# НЕ ВЫПОЛНЯЙТЕ на production без необходимости!
```

### Уровень 4: Локальное тестирование в Docker

#### 4.1. Создание тестового окружения

```bash
# 1. Создайте копию проекта для тестирования
cd /tmp
git clone /path/to/project test-deploy
cd test-deploy

# 2. Запустите контейнеры
docker compose up -d

# 3. Создайте тестовые данные (опционально)
docker compose exec web python manage.py shell < generate_test_data.py
```

#### 4.2. Тестирование на тестовом окружении

```bash
# Тест деплоя на тестовом окружении
./scripts/deploy_safe.sh --dry-run

# Если все хорошо, можно попробовать реальный деплой
./scripts/deploy_safe.sh --interactive
```

**Преимущества:**
- Полная изоляция от production
- Можно тестировать все сценарии
- Можно безопасно тестировать откат

### Уровень 5: Тестирование на staging сервере

Если у вас есть staging окружение:

```bash
# Деплой на staging сервер
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=staging@staging.example.com --dry-run

# Реальный деплой на staging
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=staging@staging.example.com
```

## Пошаговый план тестирования

### Шаг 1: Подготовка

```bash
# 1. Убедитесь, что production работает
make health-check

# 2. Создайте полный бэкап production (на всякий случай)
make backup-safe

# 3. Проверьте синтаксис скриптов
bash -n scripts/deploy_safe.sh
bash -n scripts/backup_db.sh
bash -n scripts/restore_db.sh
bash -n scripts/health_check.sh
bash -n scripts/deploy_remote.sh
```

### Шаг 2: Тестирование в dry-run режиме

```bash
# Тест основного скрипта деплоя
make deploy-safe-dry

# Проверьте вывод:
# - Все проверки должны пройти
# - Должны быть показаны все шаги
# - Не должно быть реальных изменений
```

### Шаг 3: Тестирование отдельных компонентов

```bash
# Тест бэкапа
./scripts/backup_db.sh --verify
ls -lh backups/

# Тест проверки работоспособности
make health-check-verbose

# Проверьте, что все проверки работают корректно
```

### Шаг 4: Тестирование на локальном окружении

```bash
# Если у вас локальное Docker окружение
docker compose up -d

# Тест деплоя
./scripts/deploy_safe.sh --interactive

# Отвечайте "n" (нет) на все запросы, чтобы не делать реальных изменений
# Или отвечайте "y" только на безопасные шаги
```

### Шаг 5: Тестирование на staging (если есть)

```bash
# Dry-run на staging
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=staging@staging.example.com --dry-run

# Если все хорошо - реальный деплой на staging
make deploy-remote SSH_KEY=~/.ssh/id_rsa SERVER=staging@staging.example.com
```

### Шаг 6: Тестирование на production (только после всех проверок!)

```bash
# 1. Создайте полный бэкап
make backup-safe

# 2. Dry-run на production
make deploy-safe-dry

# 3. Проверьте вывод внимательно

# 4. Если все хорошо - интерактивный деплой
make deploy-safe-interactive

# 5. Отвечайте на запросы осознанно
```

## Что тестировать в первую очередь

### ✅ Безопасно (можно делать на production)

1. **Автоматическая проверка**
   ```bash
   make test-deploy
   ```

2. **Dry-run режим**
   ```bash
   make deploy-safe-dry
   ```

3. **Проверка работоспособности**
   ```bash
   make health-check
   ```

4. **Тест бэкапа**
   ```bash
   ./scripts/backup_db.sh --verify
   ```

### ⚠️ Требует осторожности

1. **Интерактивный режим** - отвечайте "нет" на все запросы
2. **Тест восстановления** - только если готовы восстановить БД

### ❌ НЕ тестируйте на production без подготовки

1. Реальный деплой без dry-run
2. Восстановление БД без бэкапа
3. Откат без понимания последствий

## Тестовые сценарии

### Сценарий 1: Тест проверок перед деплоем

```bash
# Остановите один контейнер для теста
docker compose stop web

# Запустите dry-run
make deploy-safe-dry

# Должна быть обнаружена ошибка: "Контейнер web не запущен"
# Восстановите контейнер
docker compose start web
```

### Сценарий 2: Тест создания бэкапа

```bash
# Запустите тест бэкапа
./scripts/backup_db.sh --verify

# Проверьте:
# - Файл создан
# - Размер > 0
# - Целостность проверена
# - Старые бэкапы удалены (если настроено)
```

### Сценарий 3: Тест проверки работоспособности

```bash
# Запустите проверку
make health-check-verbose

# Проверьте все пункты:
# - Docker доступен
# - Контейнеры запущены
# - БД доступна
# - HTTP работает
# - Миграции применены
# - Нет ошибок в логах
```

### Сценарий 4: Тест отката (только на тестовом окружении!)

```bash
# 1. Создайте тестовый бэкап
./scripts/backup_db.sh

# 2. Сделайте какое-то изменение (например, добавьте тестовую таблицу)
docker compose exec db psql -U postgres satva_wellness_booking -c "CREATE TABLE test_rollback (id INT);"

# 3. Восстановите из бэкапа
BACKUP_FILE=$(ls -t backups/db_*.sql.gz | head -1)
./scripts/restore_db.sh "$BACKUP_FILE" --confirm

# 4. Проверьте, что тестовая таблица удалена
docker compose exec db psql -U postgres satva_wellness_booking -c "\dt" | grep test_rollback
# Должно быть пусто (таблица удалена)
```

## Чек-лист перед тестированием на production

- [ ] Все скрипты проверены на синтаксис
- [ ] Dry-run режим протестирован
- [ ] Отдельные компоненты протестированы
- [ ] Локальное тестирование пройдено (если возможно)
- [ ] Staging тестирование пройдено (если есть staging)
- [ ] Создан полный бэкап production БД
- [ ] Проверена работоспособность production
- [ ] Понятны все шаги деплоя
- [ ] Есть план отката при ошибках
- [ ] Есть доступ к логам для мониторинга

## Рекомендации

### Безопасность

1. **Всегда начинайте с dry-run** - это покажет, что будет сделано
2. **Используйте интерактивный режим** для первого деплоя
3. **Создавайте бэкапы** перед любыми тестами на production
4. **Тестируйте на staging** перед production
5. **Мониторьте логи** во время тестирования

### Порядок тестирования

1. Сначала - проверка синтаксиса
2. Затем - dry-run режим
3. Потом - отдельные компоненты
4. Далее - локальное окружение (если есть)
5. Затем - staging (если есть)
6. И только потом - production

### Что НЕ делать

- ❌ Не тестируйте restore на production без необходимости
- ❌ Не пропускайте dry-run перед реальным деплоем
- ❌ Не тестируйте в нерабочее время без подготовки
- ❌ Не тестируйте без создания бэкапа
- ❌ Не игнорируйте предупреждения скриптов

## Мониторинг во время тестирования

### Просмотр логов в реальном времени

```bash
# В отдельном терминале
tail -f logs/deploy_*.log

# Или логи Docker
docker compose logs -f
```

### Проверка статуса

```bash
# Статус контейнеров
docker compose ps

# Использование ресурсов
docker stats

# Проверка работоспособности
make health-check
```

## Восстановление после тестирования

Если что-то пошло не так во время тестирования:

```bash
# 1. Проверьте статус
make health-check

# 2. Проверьте логи
tail -100 logs/deploy_*.log

# 3. Если нужно откатить
BACKUP_FILE=$(ls -t backups/db_*.sql.gz | head -1)
./scripts/restore_db.sh "$BACKUP_FILE"

# 4. Или откатите код через git
git checkout <previous-commit>
docker compose up -d
```

## Вопросы для самопроверки

Перед тестированием на production ответьте на вопросы:

1. Понимаю ли я, что делает каждый скрипт?
2. Знаю ли я, как откатить изменения?
3. Есть ли у меня актуальный бэкап?
4. Знаю ли я, как проверить работоспособность?
5. Готов ли я к возможным проблемам?

Если на все вопросы ответ "да" - можно тестировать на production.

---

**Помните:** Лучше потратить больше времени на тестирование, чем потом исправлять проблемы на production!
