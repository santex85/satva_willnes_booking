{% extends 'base.html' %}

{% block title %}Календарь бронирований{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
<style>
    .calendar-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem 2rem;
        transition: max-width 0.3s ease, padding 0.3s ease;
    }
    .calendar-page.calendar-wide {
        max-width: calc(100vw - 2rem);
        padding-left: 1rem;
        padding-right: 1rem;
    }
    .calendar-page.calendar-fullscreen {
        max-width: 100vw;
        width: 100vw;
        margin-left: calc((100vw - 100%) / -2);
        margin-right: calc((100vw - 100%) / -2);
        padding-left: 1rem;
        padding-right: 1rem;
    }
    @media (min-width: 1400px) {
        .calendar-page:not(.calendar-wide):not(.calendar-fullscreen) {
            max-width: 1400px;
        }
    }
    #calendar {
        width: 100%;
        margin: 0 auto;
    }
    .fc-event-title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .fc-daygrid-day:hover,
    .fc-timegrid-slot:hover {
        cursor: pointer;
    }
    .fc .fc-timegrid-now-indicator-line,
    .fc .fc-daygrid-now-indicator-line {
        border-top: 2px solid #ff4d4f;
    }
    .fc .fc-timegrid-now-indicator-arrow {
        border-color: transparent transparent #ff4d4f transparent;
    }
    .fc .fc-daygrid-now-indicator-dot {
        background: #ff4d4f;
        border-color: #ff4d4f;
    }
    .legend {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid;
        flex-shrink: 0;
    }
    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .fc-header-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .fc-button-group {
            width: 100%;
            display: flex;
        }
        .fc-button {
            flex: 1;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .fc-today-button {
            width: 100%;
        }
        .fc-prev-button, .fc-next-button {
            flex: 0 0 auto;
        }
        .legend {
            gap: 0.5rem;
            padding: 0.5rem;
        }
        .legend-item {
            font-size: 0.75rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
        }
        .btn-group {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 80px;
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
        }
    }
    /* Улучшение модальных окон для мобильных */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 0.5rem;
        }
        .modal-content {
            border-radius: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="calendar-page" class="calendar-page">
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
    <h1 class="h3 mb-2 mb-md-0"><i class="bi bi-calendar-week"></i> Календарь бронирований</h1>
    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
        <button type="button" id="toggle-width-btn" class="btn btn-outline-secondary flex-fill flex-sm-grow-0" onclick="toggleCalendarWidth()">
            <i class="bi bi-arrows-expand"></i> Широкий режим
        </button>
        <a href="{% url 'select_service' %}" class="btn btn-primary flex-fill flex-sm-grow-0">
            <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">Создать бронирование</span><span class="d-sm-none">Создать</span>
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-3 mb-3">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="btn-group" role="group" aria-label="Навигация по календарю">
                    <button type="button" class="btn btn-outline-secondary" id="calendar-prev-btn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="calendar-today-btn">
                        Сегодня
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="calendar-next-btn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div id="calendar-current-range" class="fw-semibold text-nowrap"></div>
            </div>
            <div class="btn-group w-100 w-xl-auto" role="group">
                <button type="button" class="btn btn-outline-primary" data-view-switch="dayGridMonth" onclick="switchView('dayGridMonth')">
                    <i class="bi bi-calendar3"></i> <span class="d-none d-sm-inline">Месяц</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridWeek" onclick="switchView('timeGridWeek')">
                    <i class="bi bi-grid-3x3"></i> <span class="d-none d-sm-inline">Неделя</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridThreeDay" onclick="switchView('timeGridThreeDay')">
                    <i class="bi bi-calendar-range"></i> <span class="d-none d-sm-inline">3 дня</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-view-switch="timeGridDay" onclick="switchView('timeGridDay')">
                    <i class="bi bi-calendar-day"></i> <span class="d-none d-sm-inline">День</span>
                </button>
            </div>

        </div>

        <!-- Легенда кабинетов -->
        <div class="legend">
            {% for item in cabinets_with_colors %}
            <div class="legend-item">
                <div class="legend-color" style="background-color: {{ item.bg_color }}; border-color: {{ item.border_color }};"></div>
                <span>{{ item.cabinet.name }}</span>
            </div>
            {% endfor %}
        </div>

        <div id="calendar"></div>
    </div>
</div>
</div>

<!-- Модальное окно для быстрого создания бронирования -->
<div class="modal fade" id="quickBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Создать бронирование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickBookingForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-calendar3"></i> Дата и время: <strong id="selectedDateTime"></strong>
                    </div>

                    <div class="mb-3">
                        <label for="service_variant" class="form-label">Услуга *</label>
                        <select class="form-select" id="service_variant" name="service_variant" required>
                            <option value="">Выберите услугу</option>
                            {% for group in service_groups %}
                            <optgroup label="{{ group.label }}">
                                {% for service in group.variants %}
                                <option value="{{ service.id }}">{{ service.service.name }} - {{ service.name_suffix }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="specialist" class="form-label">Специалист *</label>
                        <select class="form-select" id="specialist" name="specialist" required>
                            <option value="">Сначала выберите услугу</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cabinet" class="form-label">Кабинет</label>
                        <select class="form-select" id="cabinet" name="cabinet">
                            <option value="">Сначала выберите услугу, специалиста и время</option>
                        </select>
                        <small class="form-text text-muted">Будет выбран автоматически, если не указан</small>
                    </div>

                    <div class="mb-3">
                        <label for="guest_name" class="form-label">Имя гостя *</label>
                        <input type="text" class="form-control" id="guest_name" name="guest_name" required>
                    </div>

                    <div class="mb-3">
                        <label for="guest_room_number" class="form-label">Номер комнаты</label>
                        <input type="text" class="form-control" id="guest_room_number" name="guest_room_number">
                    </div>

                    <div class="card border-warning-subtle mb-3" data-role="quick-recurrence-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                                <h6 class="mb-0"><i class="bi bi-arrow-repeat me-2 text-warning"></i>Повтор бронирования</h6>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input" type="checkbox" id="quick_recurrence_enabled" name="recurrence_enabled">
                                    <label class="form-check-label ms-2" for="quick_recurrence_enabled">Включить повтор</label>
                                </div>
                            </div>
                            <div class="recurrence-settings d-none" data-role="quick-recurrence-settings">
                                <div class="row g-3 mb-3">
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_frequency">Частота</label>
                                        <select class="form-select" id="quick_recurrence_frequency" name="recurrence_frequency">
                                            {% for value, label in quick_form.recurrence_frequency.field.choices %}
                                            <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_interval">Каждые</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="quick_recurrence_interval" name="recurrence_interval" min="1" value="1">
                                            <span class="input-group-text" data-role="quick-recurrence-interval-label">дней</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 d-none" data-role="quick-recurrence-weekdays">
                                    <label class="form-label d-block">Повторять по дням недели</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for value, label in quick_form.recurrence_weekdays.field.choices %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="quick_weekday_{{ value }}" name="recurrence_weekdays" value="{{ value }}">
                                            <label class="form-check-label ms-1" for="quick_weekday_{{ value }}">{{ label }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="row g-3 mb-3 align-items-end">
                                    <div class="col-12 col-md-6">
                                        <label class="form-label" for="quick_recurrence_end_type">Завершить</label>
                                        <select class="form-select" id="quick_recurrence_end_type" name="recurrence_end_type">
                                            {% for value, label in quick_form.recurrence_end_type.field.choices %}
                                            <option value="{{ value }}" {% if quick_form.recurrence_end_type.field.initial == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6" data-role="quick-recurrence-count-field">
                                        <label class="form-label" for="quick_recurrence_occurrences">Количество повторов</label>
                                        <input type="number" class="form-control" id="quick_recurrence_occurrences" name="recurrence_occurrences" min="2" value="2">
                                    </div>
                                    <div class="col-12 col-md-6 d-none" data-role="quick-recurrence-until-field">
                                        <label class="form-label" for="quick_recurrence_end_date">Дата окончания</label>
                                        <input type="date" class="form-control" id="quick_recurrence_end_date" name="recurrence_end_date">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="quick_recurrence_excluded_display">Пропустить даты</label>
                                    <input type="text" class="form-control" id="quick_recurrence_excluded_display" data-role="quick-recurrence-excluded-display" placeholder="Например: 20.11.2025, 25.11.2025">
                                    <input type="hidden" id="quick_recurrence_excluded_dates" name="recurrence_excluded_dates">
                                    <div class="form-text text-muted">Введите даты через запятую. Используйте формат ДД.ММ.ГГГГ.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="start_datetime" name="start_datetime" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="quick-booking-cancel">Отмена</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Создать
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для результатов -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="resultHeader">
                <h5 class="modal-title" id="resultTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования бронирования -->
<div class="modal fade" id="bookingEditModal" tabindex="-1" aria-labelledby="bookingEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingEditModalLabel"><i class="bi bi-pencil-square"></i> Редактировать бронирование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bookingEditModalBody">
                <div class="text-center py-5" id="bookingEditModalLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3 text-muted">Загружаем данные бронирования…</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% include 'booking/partials/booking_edit_form_script.html' %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales/ru.js"></script>
<script>
    let calendar;
    let currentView = 'timeGridDay';
    let currentResourceType = 'specialist';
    const SUPPORTED_VIEWS = ['dayGridMonth', 'timeGridWeek', 'timeGridThreeDay', 'timeGridDay'];
    const WIDTH_MODE_STORAGE_KEY = 'calendarWidthMode';
    const VIEW_STORAGE_KEY = 'calendarView';
    const DATE_STORAGE_KEY = 'calendarDate';
    let currentWidthMode = 'standard'; // standard | wide | fullscreen
    let currentDate = null;
    let quickBookingModal = null;
    const quickBookingFormEl = document.getElementById('quickBookingForm');
    const quickRecurrenceToggle = document.getElementById('quick_recurrence_enabled');
    const quickRecurrenceSettings = document.querySelector('[data-role="quick-recurrence-settings"]');
    const quickRecurrenceFrequency = document.getElementById('quick_recurrence_frequency');
    const quickRecurrenceIntervalLabel = document.querySelector('[data-role="quick-recurrence-interval-label"]');
    const quickRecurrenceWeekdaysBlock = document.querySelector('[data-role="quick-recurrence-weekdays"]');
    const quickRecurrenceEndType = document.getElementById('quick_recurrence_end_type');
    const quickRecurrenceCountField = document.querySelector('[data-role="quick-recurrence-count-field"]');
    const quickRecurrenceUntilField = document.querySelector('[data-role="quick-recurrence-until-field"]');
    const quickRecurrenceOccurrences = document.getElementById('quick_recurrence_occurrences');
    const quickRecurrenceExcludedDisplay = document.querySelector('[data-role="quick-recurrence-excluded-display"]');
    const quickRecurrenceExcludedHidden = document.getElementById('quick_recurrence_excluded_dates');
    let bookingEditModal;
    const bookingEditModalEl = document.getElementById('bookingEditModal');
    const bookingEditModalBody = document.getElementById('bookingEditModalBody');

    // Получаем CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function() {
        restoreWidthMode();
        applyWidthModeClass();
        restoreViewState();
        updateViewSwitcherButtons();
        initCalendar();
        updateWidthButton();
        initQuickBookingModal();
        attachNavigationControls();
        updateCalendarTitle();
    });

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: currentView,
            initialDate: currentDate || undefined,
            locale: 'ru',
            headerToolbar: false,
            nowIndicator: true,
            views: {
                timeGridThreeDay: {
                    type: 'timeGrid',
                    duration: { days: 3 }
                }
            },
            // Адаптивность для мобильных устройств
            height: 'auto',
            aspectRatio: window.innerWidth < 768 ? 1.5 : 1.8,
            eventDisplay: 'block',
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            events: '/calendar/feed/',
            slotMinTime: '08:00:00',
            slotMaxTime: '22:00:00',
            slotDuration: '00:30:00',
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                saveViewState();
                openBookingEditModal(info.event.id);
            },
            dateClick: function(info) {
                // Обработка клика на свободный слот
                const view = info.view.type;
                
                if (view === 'dayGridMonth') {
                    // В месячном виде открываем модальное окно с выбранной датой
                    // Устанавливаем время на начало рабочего дня (например, 09:00)
                    const selectedDate = new Date(info.date);
                    selectedDate.setHours(9, 0, 0, 0); // Устанавливаем 09:00
                    openQuickBookingModal(selectedDate, info.dateStr);
                } else {
                    // В временных видах (неделя, день) используем точное время клика
                    openQuickBookingModal(info.date, info.dateStr);
                }
            },
            eventDidMount: function(info) {
                const viewType = info.view ? info.view.type : calendar.view.type;
                if (viewType === 'timeGridWeek' || viewType === 'timeGridDay') {
                    const currentRight = info.el.style.right;
                    if (!currentRight || currentRight === '0%') {
                        info.el.style.right = '25%';
                    }
                } else {
                    info.el.style.right = '';
                }
            },
            eventDrop: function(info) {
                // Обработка перетаскивания события
                handleEventDrop(info);
            },
            datesSet: function() {
                saveViewState();
                updateViewSwitcherButtons();
                updateCalendarTitle();
            },
            eventStartEditable: true,
            eventDurationEditable: false,  // Запрещаем изменение длительности через drag
            editable: true,
            allDaySlot: false
        });

        calendar.render();
        setTimeout(() => calendar.updateSize(), 100);
    }

    function switchView(viewType) {
        currentView = viewType;
        if (calendar) {
            calendar.setOption('visibleRange', null);
            calendar.changeView(viewType);
            saveViewState();
            updateViewSwitcherButtons();
            updateCalendarTitle();
        }
    }

    function updateWidthButton() {
        const btn = document.getElementById('toggle-width-btn');
        if (!btn) return;
        const modes = {
            standard: { text: 'Широкий режим', icon: 'bi bi-arrows-expand' },
            wide: { text: 'Полноэкр.', icon: 'bi bi-arrows-fullscreen' },
            fullscreen: { text: 'Стандартный режим', icon: 'bi bi-arrows-collapse' }
        };
        const mode = modes[currentWidthMode] || modes.standard;
        btn.innerHTML = `<i class="${mode.icon}"></i> ${mode.text}`;
    }

    function updateViewSwitcherButtons() {
        const buttons = document.querySelectorAll('[data-view-switch]');
        buttons.forEach(button => {
            const targetView = button.getAttribute('data-view-switch');
            if (targetView === currentView) {
                button.classList.add('active', 'btn-primary');
                button.classList.remove('btn-outline-primary');
            } else {
                button.classList.remove('active', 'btn-primary');
                button.classList.add('btn-outline-primary');
            }
        });
    }

    function attachNavigationControls() {
        const prevBtn = document.getElementById('calendar-prev-btn');
        const nextBtn = document.getElementById('calendar-next-btn');
        const todayBtn = document.getElementById('calendar-today-btn');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => navigateCalendar(-1));
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => navigateCalendar(1));
        }

        if (todayBtn) {
            todayBtn.addEventListener('click', () => goToToday());
        }
    }

    function updateCalendarTitle() {
        const titleContainer = document.getElementById('calendar-current-range');
        if (!titleContainer || !calendar || !calendar.view) {
            return;
        }
        titleContainer.textContent = calendar.view.title || '';
    }

    function toggleCalendarWidth() {
        const container = document.getElementById('calendar-page');
        if (!container) return;

        if (currentWidthMode === 'standard') {
            currentWidthMode = 'wide';
        } else if (currentWidthMode === 'wide') {
            currentWidthMode = 'fullscreen';
        } else {
            currentWidthMode = 'standard';
        }

        applyWidthModeClass();
        updateWidthButton();
        saveWidthMode();
        if (calendar) {
            setTimeout(() => calendar.updateSize(), 200);
        }
    }

    function applyWidthModeClass() {
        const container = document.getElementById('calendar-page');
        if (!container) return;

        container.classList.remove('calendar-wide', 'calendar-fullscreen');

        if (currentWidthMode === 'wide') {
            container.classList.add('calendar-wide');
        } else if (currentWidthMode === 'fullscreen') {
            container.classList.add('calendar-fullscreen');
        }
    }

    function saveWidthMode() {
        try {
            localStorage.setItem(WIDTH_MODE_STORAGE_KEY, currentWidthMode);
        } catch (e) {
            console.warn('Unable to save width mode preference', e);
        }
    }

    function restoreWidthMode() {
        try {
            const savedMode = localStorage.getItem(WIDTH_MODE_STORAGE_KEY);
            if (savedMode && ['standard', 'wide', 'fullscreen'].includes(savedMode)) {
                currentWidthMode = savedMode;
            }
        } catch (e) {
            console.warn('Unable to read width mode preference', e);
        }
    }

    function toggleQuickRecurrenceSettings(forceEnabled) {
        if (!quickRecurrenceSettings || !quickRecurrenceToggle) return;
        const enabled = typeof forceEnabled === 'boolean' ? forceEnabled : quickRecurrenceToggle.checked;
        quickRecurrenceSettings.classList.toggle('d-none', !enabled);
        if (!enabled) {
            if (quickRecurrenceExcludedDisplay) quickRecurrenceExcludedDisplay.value = '';
            if (quickRecurrenceExcludedHidden) quickRecurrenceExcludedHidden.value = '';
        }
    }

    function updateQuickRecurrenceIntervalLabel() {
        if (!quickRecurrenceIntervalLabel || !quickRecurrenceFrequency) return;
        const freq = quickRecurrenceFrequency.value;
        let suffix = 'дней';
        switch (freq) {
            case 'weekly':
                suffix = 'недель';
                break;
            case 'monthly':
                suffix = 'месяцев';
                break;
            case 'yearly':
                suffix = 'лет';
                break;
        }
        quickRecurrenceIntervalLabel.textContent = suffix;
    }

    function updateQuickRecurrenceFrequencyState() {
        updateQuickRecurrenceIntervalLabel();
        if (!quickRecurrenceWeekdaysBlock) return;
        if (quickRecurrenceFrequency && quickRecurrenceFrequency.value === 'weekly') {
            quickRecurrenceWeekdaysBlock.classList.remove('d-none');
        } else {
            quickRecurrenceWeekdaysBlock.classList.add('d-none');
        }
    }

    function updateQuickRecurrenceEndState() {
        if (!quickRecurrenceEndType) return;
        const type = quickRecurrenceEndType.value || 'count';
        if (quickRecurrenceCountField) {
            quickRecurrenceCountField.classList.toggle('d-none', type !== 'count');
        }
        if (quickRecurrenceUntilField) {
            quickRecurrenceUntilField.classList.toggle('d-none', type !== 'until');
        }
    }

    function syncQuickExcludedDates() {
        if (!quickRecurrenceExcludedHidden || !quickRecurrenceExcludedDisplay) return;
        const raw = quickRecurrenceExcludedDisplay.value.trim();
        if (!raw) {
            quickRecurrenceExcludedHidden.value = '';
            return;
        }
        const parts = raw.split(',').map((item) => item.trim()).filter(Boolean);
        const isoDates = [];
        parts.forEach((item) => {
            if (!item) return;
            const normalized = item.replace(/\//g, '.');
            const isoMatch = normalized.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (isoMatch) {
                isoDates.push(`${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`);
                return;
            }
            const match = normalized.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                isoDates.push(`${year}-${month}-${day}`);
            }
        });
        quickRecurrenceExcludedHidden.value = isoDates.length ? JSON.stringify(isoDates) : '';
    }

    function resetQuickRecurrenceControls() {
        if (!quickRecurrenceToggle) return;
        quickRecurrenceToggle.checked = false;
        toggleQuickRecurrenceSettings(false);
        if (quickRecurrenceFrequency && quickRecurrenceFrequency.options.length) {
            quickRecurrenceFrequency.value = quickRecurrenceFrequency.options[0].value;
        }
        if (quickRecurrenceOccurrences) {
            quickRecurrenceOccurrences.value = 2;
        }
        if (quickRecurrenceEndType) {
            quickRecurrenceEndType.value = 'count';
        }
        if (quickRecurrenceWeekdaysBlock) {
            quickRecurrenceWeekdaysBlock.querySelectorAll('input[type=\"checkbox\"]').forEach((checkbox) => {
                checkbox.checked = false;
            });
        }
        if (quickRecurrenceExcludedDisplay) quickRecurrenceExcludedDisplay.value = '';
        if (quickRecurrenceExcludedHidden) quickRecurrenceExcludedHidden.value = '';
        updateQuickRecurrenceFrequencyState();
        updateQuickRecurrenceEndState();
    }

    if (quickRecurrenceToggle) {
        quickRecurrenceToggle.addEventListener('change', function() {
            toggleQuickRecurrenceSettings();
        });
    }

    if (quickRecurrenceFrequency) {
        quickRecurrenceFrequency.addEventListener('change', function() {
            updateQuickRecurrenceFrequencyState();
        });
    }

    if (quickRecurrenceEndType) {
        quickRecurrenceEndType.addEventListener('change', function() {
            updateQuickRecurrenceEndState();
        });
    }

    if (quickRecurrenceExcludedDisplay) {
        quickRecurrenceExcludedDisplay.addEventListener('blur', syncQuickExcludedDates);
    }

    toggleQuickRecurrenceSettings(quickRecurrenceToggle ? quickRecurrenceToggle.checked : false);
    updateQuickRecurrenceFrequencyState();
    updateQuickRecurrenceEndState();

    function openBookingEditModal(bookingId) {
        if (!bookingEditModalEl || !bookingEditModalBody) {
            window.location.href = `/booking/${bookingId}/`;
            return;
        }

        if (!bookingEditModal) {
            bookingEditModal = new bootstrap.Modal(bookingEditModalEl);
        }

        bookingEditModalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-3 text-muted">Загружаем данные бронирования…</p>
            </div>
        `;

        bookingEditModal.show();

        fetch(`/booking/${bookingId}/?modal=1`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.success) {
                    throw new Error(data && data.error ? data.error : 'Ошибка загрузки бронирования');
                }
                bookingEditModalBody.innerHTML = data.html;
                initBookingEditForm(bookingEditModalBody, {
                    onInit(form) {
                        form.dataset.ajax = 'true';
                        form.addEventListener('submit', handleBookingModalSubmit);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading booking form:', error);
                bookingEditModalBody.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Не удалось загрузить форму. <a href="/booking/${bookingId}/" class="alert-link">Открыть на отдельной странице</a>.
                    </div>
                `;
            });
    }

    function handleBookingModalSubmit(event) {
        event.preventDefault();
        const form = event.target;
        if (!form) return;

        if (form.dataset.submitting === 'true') {
            return;
        }
        form.dataset.submitting = 'true';

        const submitButton = form.querySelector('button[type="submit"]');
        let originalButtonHTML = '';
        if (submitButton) {
            originalButtonHTML = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...';
        }

        const formData = new FormData(form);
        const actionUrl = form.getAttribute('action') || `/booking/${form.dataset.bookingId}/`;

        fetch(actionUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw data;
                    }).catch(() => {
                        throw new Error('Ошибка при сохранении бронирования');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    bookingEditModal.hide();
                    calendar.refetchEvents();
                    showResultModal('Успех', data.message || 'Бронирование успешно обновлено', true);
                } else {
                    if (data.html) {
                        bookingEditModalBody.innerHTML = data.html;
                        initBookingEditForm(bookingEditModalBody, {
                            onInit(newForm) {
                                newForm.dataset.ajax = 'true';
                                newForm.addEventListener('submit', handleBookingModalSubmit);
                            }
                        });
                    }
                    if (data.error) {
                        showResultModal('Ошибка', data.error, false);
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting booking form:', error);
                const message = error && error.error ? error.error : (error && error.message ? error.message : 'Не удалось сохранить изменения. Попробуйте позже.');
                showResultModal('Ошибка', message, false);
            })
            .finally(() => {
                if (submitButton && submitButton.isConnected) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                }
                form.dataset.submitting = 'false';
            });
    }

    function openQuickBookingModal(date, dateStr) {
        // Форматируем дату для отображения
        const localDate = new Date(date);
        
        // Проверяем, является ли это кликом из месячного вида
        const isMonthView = calendar.view.type === 'dayGridMonth';
        
        let formattedDate;
        if (isMonthView) {
            // Для месячного вида показываем только дату без времени
            formattedDate = localDate.toLocaleDateString('ru-RU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } else {
            // Для временных видов показываем дату и время
            formattedDate = localDate.toLocaleString('ru-RU', {
                weekday: 'short',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        document.getElementById('selectedDateTime').textContent = formattedDate;

        // Форматируем дату в локальное время для отправки на сервер
        // Формат: YYYY-MM-DDTHH:MM (локальное время, не UTC)
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const day = String(localDate.getDate()).padStart(2, '0');
        const hours = String(localDate.getHours()).padStart(2, '0');
        const minutes = String(localDate.getMinutes()).padStart(2, '0');
        const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

        document.getElementById('start_datetime').value = localDateTime;

        // Сбрасываем форму
        document.getElementById('quickBookingForm').reset();
        document.getElementById('start_datetime').value = localDateTime;
        document.getElementById('specialist').innerHTML = '<option value="">Сначала выберите услугу</option>';
        document.getElementById('cabinet').innerHTML = '<option value="">Сначала выберите услугу, специалиста и время</option>';
        resetQuickRecurrenceControls();

        // Показываем модальное окно
        if (!quickBookingModal) {
            quickBookingModal = new bootstrap.Modal(document.getElementById('quickBookingModal'));
        }
        quickBookingModal.show();
        
        // Загружаем кабинеты автоматически при показе модального окна, если услуга и специалист уже выбраны
        const modalElement = document.getElementById('quickBookingModal');
        const handleModalShown = function() {
            setTimeout(function() {
                const serviceVariantId = document.getElementById('service_variant').value;
                const specialistId = document.getElementById('specialist').value;
                const startDatetime = document.getElementById('start_datetime').value;
                
                if (serviceVariantId && specialistId && startDatetime) {
                    loadAvailableCabinets();
                }
            }, 100);
        };
        modalElement.addEventListener('shown.bs.modal', handleModalShown, { once: true });
    }

    function initQuickBookingModal() {
        const modalElement = document.getElementById('quickBookingModal');
        if (!modalElement) return;

        quickBookingModal = new bootstrap.Modal(modalElement);
        resetQuickRecurrenceControls();

        const cancelButton = modalElement.querySelector('[data-action="quick-booking-cancel"]');
        if (cancelButton) {
            cancelButton.addEventListener('click', function() {
                hideQuickBookingModal();
            });
        }
    }

    function hideQuickBookingModal() {
        if (quickBookingModal) {
            quickBookingModal.hide();
            return;
        }

        const modalElement = document.getElementById('quickBookingModal');
        if (!modalElement) return;
        const instance = bootstrap.Modal.getInstance(modalElement);
        if (instance) {
            instance.hide();
        }
    }

    function handleEventDrop(info) {
        // Откатываем событие на случай ошибки
        const revert = info.revert;

        const event = info.event;
        const newStart = event.start;
        const bookingId = event.id;

        // Форматируем дату в локальное время (YYYY-MM-DDTHH:MM)
        // FullCalendar работает с локальным временем, поэтому просто форматируем
        const year = newStart.getFullYear();
        const month = String(newStart.getMonth() + 1).padStart(2, '0');
        const day = String(newStart.getDate()).padStart(2, '0');
        const hours = String(newStart.getHours()).padStart(2, '0');
        const minutes = String(newStart.getMinutes()).padStart(2, '0');
        const startDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;

        // Отправляем AJAX запрос
        const formData = new FormData();
        formData.append('booking_id', bookingId);
        formData.append('start_datetime', startDatetime);

        fetch('/booking/update-time/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Показываем ошибку
                showResultModal('Ошибка', data.error, false);
                // Откатываем изменение
                revert();
                // Обновляем календарь
                calendar.refetchEvents();
            } else {
                // Показываем успех
                showResultModal('Успех', 'Время бронирования изменено', true);
            }
        })
        .catch(error => {
            console.error('Error updating booking time:', error);
            showResultModal('Ошибка', 'Произошла ошибка при изменении времени', false);
            // Откатываем изменение
            revert();
            // Обновляем календарь
            calendar.refetchEvents();
        });
    }

    function saveViewState() {
        if (!calendar) return;
        try {
            currentView = calendar.view.type;
            const currentMoment = calendar.getDate();
            currentDate = currentMoment;
            localStorage.setItem(VIEW_STORAGE_KEY, currentView);
            localStorage.setItem(DATE_STORAGE_KEY, currentMoment.toISOString());
        } catch (e) {
            console.warn('Unable to persist calendar view state', e);
        }
    }

    function restoreViewState() {
        try {
            const savedView = localStorage.getItem(VIEW_STORAGE_KEY);
            const allowedViews = ['dayGridMonth', 'timeGridWeek', 'timeGridDay', 'timeGridThreeDay'];
            if (savedView && allowedViews.includes(savedView)) {
                currentView = savedView;
            }
            const savedDate = localStorage.getItem(DATE_STORAGE_KEY);
            if (savedDate) {
                const parsedDate = new Date(savedDate);
                if (!isNaN(parsedDate.getTime())) {
                    currentDate = parsedDate;
                }
            }
        } catch (e) {
            console.warn('Unable to restore calendar view state', e);
        }
    }

    function showResultModal(title, message, isSuccess) {
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        document.getElementById('resultTitle').textContent = title;
        document.getElementById('resultHeader').className = isSuccess ? 'modal-header bg-success text-white' : 'modal-header bg-danger text-white';
        document.getElementById('resultBody').innerHTML = `<p>${message}</p>`;
        resultModal.show();

        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
        }, 2000);
    }

    // Функция загрузки доступных кабинетов
    function loadAvailableCabinets() {
        const serviceVariantId = document.getElementById('service_variant').value;
        const specialistId = document.getElementById('specialist').value;
        const startDatetime = document.getElementById('start_datetime').value;
        const cabinetSelect = document.getElementById('cabinet');

        if (!serviceVariantId || !specialistId || !startDatetime) {
            cabinetSelect.innerHTML = '<option value="">Сначала выберите услугу, специалиста и время</option>';
            return;
        }

        // Показываем загрузку
        cabinetSelect.innerHTML = '<option value="">Загрузка...</option>';
        cabinetSelect.disabled = true;

        // Загружаем доступные кабинеты
        fetch(`/api/available-cabinets/?service_variant_id=${serviceVariantId}&specialist_id=${specialistId}&datetime=${encodeURIComponent(startDatetime)}`)
            .then(response => response.json())
            .then(data => {
                cabinetSelect.disabled = false;
                if (data.error) {
                    cabinetSelect.innerHTML = `<option value="">${data.error}</option>`;
                    return;
                }

                cabinetSelect.innerHTML = '<option value="">-- Выберите кабинет (опционально) --</option>';
                if (data.cabinets && data.cabinets.length > 0) {
                    data.cabinets.forEach(cabinet => {
                        const option = document.createElement('option');
                        option.value = cabinet.id;
                        option.textContent = cabinet.name;
                        cabinetSelect.appendChild(option);
                    });
                } else {
                    cabinetSelect.innerHTML = '<option value="">Нет доступных кабинетов</option>';
                }
            })
            .catch(error => {
                console.error('Error loading cabinets:', error);
                cabinetSelect.disabled = false;
                cabinetSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            });
    }

    // Загрузка специалистов при выборе услуги
    document.getElementById('service_variant').addEventListener('change', function() {
        const serviceVariantId = this.value;
        const specialistSelect = document.getElementById('specialist');

        if (!serviceVariantId) {
            specialistSelect.innerHTML = '<option value="">Сначала выберите услугу</option>';
            document.getElementById('cabinet').innerHTML = '<option value="">Сначала выберите услугу, специалиста и время</option>';
            return;
        }

        // Показываем загрузку
        specialistSelect.innerHTML = '<option value="">Загрузка...</option>';

        // Загружаем специалистов
        fetch(`/api/specialists-for-service/?service_variant_id=${serviceVariantId}`)
            .then(response => response.json())
            .then(data => {
                specialistSelect.innerHTML = '<option value="">Выберите специалиста</option>';
                data.forEach(specialist => {
                    const option = document.createElement('option');
                    option.value = specialist.id;
                    option.textContent = specialist.full_name;
                    specialistSelect.appendChild(option);
                });
                
                // Сбрасываем кабинеты
                document.getElementById('cabinet').innerHTML = '<option value="">Сначала выберите специалиста и время</option>';
            })
            .catch(error => {
                console.error('Error loading specialists:', error);
                specialistSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            });
    });

    // Загрузка кабинетов при изменении специалиста
    document.getElementById('specialist').addEventListener('change', function() {
        loadAvailableCabinets();
    });

    // Обработка отправки формы
    document.getElementById('quickBookingForm').addEventListener('submit', function(e) {
        e.preventDefault();

        syncQuickExcludedDates();

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Создание...';

        fetch('/booking/quick-create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-check-circle"></i> Создать';

            // Закрываем модальное окно формы
            hideQuickBookingModal();

            // Показываем результат
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));

            if (data.success) {
                document.getElementById('resultTitle').textContent = 'Успех';
                document.getElementById('resultHeader').className = 'modal-header bg-success text-white';
                document.getElementById('resultBody').innerHTML = `<p>${data.message}</p>`;
            } else {
                document.getElementById('resultTitle').textContent = 'Ошибка';
                document.getElementById('resultHeader').className = 'modal-header bg-danger text-white';
                document.getElementById('resultBody').innerHTML = `<p>${data.error}</p>`;
            }

            resultModal.show();

            // Обновляем календарь
            calendar.refetchEvents();

            // Закрываем модальное окно результата через 2 секунды
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
            }, 2000);
        })
        .catch(error => {
            console.error('Error creating booking:', error);
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-check-circle"></i> Создать';

            hideQuickBookingModal();

            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            document.getElementById('resultTitle').textContent = 'Ошибка';
            document.getElementById('resultHeader').className = 'modal-header bg-danger text-white';
            document.getElementById('resultBody').innerHTML = '<p>Произошла ошибка при создании бронирования</p>';
            resultModal.show();
        });
    });

    function navigateCalendar(direction) {
        if (!calendar) return;
        if (direction < 0) {
            calendar.prev();
        } else {
            calendar.next();
        }
    }

    function goToToday() {
        if (!calendar) return;
        calendar.today();
    }

</script>
{% endblock %}

