# Быстрый откат к предыдущему состоянию

## Описание

Механизм быстрого отката позволяет вернуть production систему к предыдущему состоянию одной командой после успешного деплоя.

## Как это работает

После каждого успешного деплоя автоматически сохраняется файл `deploy_state.json` с информацией:
- Previous commit (предыдущий commit)
- Current commit (текущий commit после деплоя)
- Backup file (путь к бэкапу БД)
- Deploy log (путь к логу деплоя)
- Deploy date (дата деплоя)

Эта информация используется для быстрого отката.

## Использование

### Показать информацию о последнем деплое

```bash
make rollback-info
```

Или напрямую:
```bash
./scripts/rollback_quick.sh --info
```

### Быстрый откат к предыдущему состоянию

```bash
# С подтверждением (рекомендуется)
make rollback-quick

# Без подтверждения (опасно!)
./scripts/rollback_quick.sh --confirm
```

### Проверка без реального отката

```bash
./scripts/rollback_quick.sh --dry-run
```

### Откат к конкретному состоянию

```bash
./scripts/rollback_quick.sh --to-state=deploy_states/deploy_state_20260123_143000.json
```

## Что делает откат

1. **Создает бэкап текущего состояния БД** (на случай если откат не поможет)
2. **Откатывает код** к previous_commit через git checkout
3. **Восстанавливает БД** из backup_file
4. **Перезапускает контейнеры**
5. **Проверяет работоспособность** после отката

## Безопасность

- **Автоматический бэкап** перед откатом - позволяет вернуться если откат не помог
- **Проверка целостности** бэкапа перед восстановлением
- **Подтверждение** по умолчанию (можно пропустить с --confirm)
- **Проверка работоспособности** после отката

## Когда использовать

Используйте быстрый откат если:
- После деплоя обнаружены критические ошибки
- Нужно быстро вернуться к предыдущей версии
- Что-то пошло не так и нужно откатить изменения

## Пример использования

```bash
# 1. Проверка информации о последнем деплое
make rollback-info

# 2. Быстрый откат
make rollback-quick
# Отвечайте "yes" на запрос подтверждения

# 3. Проверка работоспособности
make health-check
```

## Важно

- Откат вернет систему к состоянию **до последнего деплоя**
- Все данные, созданные после деплоя, будут потеряны (если не были в бэкапе)
- Откат создает бэкап текущего состояния перед откатом
- Используйте откат только если действительно нужно вернуться к предыдущей версии

## Файлы

- `deploy_state.json` - текущее состояние деплоя (создается автоматически)
- `deploy_states/` - архивные состояния (последние 5)
- `backups/pre_rollback_*.sql.gz` - бэкапы перед откатом

## Интеграция с деплоем

Механизм быстрого отката автоматически интегрирован с `deploy_safe.sh`:
- После успешного деплоя автоматически сохраняется состояние
- Информация доступна для быстрого отката
- Не требует дополнительных действий

---

**Примечание:** Быстрый откат работает только если был выполнен деплой через `deploy_safe.sh`, который сохраняет состояние.
