# Инструкция по сбору информации с сервера перед деплоем

## Зачем это нужно?

Перед деплоем нового кода необходимо собрать информацию о текущей конфигурации на production сервере, чтобы:
- Не потерять настройки при деплое
- Понять текущую версию кода на сервере
- Задокументировать конфигурацию Docker, Nginx, БД
- Сохранить переменные окружения
- Избежать проблем при обновлении

## Быстрый старт

### 1. Подготовка SSH ключа

Убедитесь, что у вас есть SSH ключ с доступом к серверу:

```bash
# Проверьте наличие ключа
ls -la ~/.ssh/id_rsa

# Если ключа нет, создайте его (или используйте существующий)
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# Скопируйте публичный ключ на сервер (если нужно)
ssh-copy-id -i ~/.ssh/id_rsa.pub root@188.166.240.56
```

### 2. Проверка подключения

Проверьте, что вы можете подключиться к серверу:

```bash
ssh -i ~/.ssh/id_rsa root@188.166.240.56
```

Если подключение успешно, выйдите (`exit`) и переходите к следующему шагу.

### 3. Запуск скрипта сбора информации

```bash
# Перейдите в директорию проекта
cd "/Users/alex/projects/Satva willnes booking"

# Запустите скрипт
./scripts/collect_server_info.sh ~/.ssh/id_rsa root@188.166.240.56
```

### 4. Результат

После выполнения скрипта вы получите файл `server_info_YYYYMMDD_HHMMSS.md` в корне проекта.

## Что собирает скрипт

### Критичная информация для деплоя

1. **Переменные окружения** - список всех переменных из `.env` (имена без значений)
2. **Docker конфигурация** - текущий `docker-compose.yml`
3. **Nginx конфигурация** - текущий `nginx/nginx.conf`
4. **База данных** - версия, размер, последние миграции
5. **SSL сертификаты** - информация о Let's Encrypt
6. **Версия кода** - текущий Git commit на сервере
7. **Статус контейнеров** - какие контейнеры запущены

### Дополнительная информация

- Системные ресурсы (диск, память, CPU)
- Логи приложения (последние ошибки)
- Резервные копии БД
- Cron задачи
- Firewall настройки

## Использование собранной информации

### Перед деплоем

1. **Откройте отчет** `server_info_*.md`
2. **Проверьте критичные настройки**:
   - Переменные окружения (особенно `DJANGO_SECRET_KEY`, `DATABASE_*`, `ALLOWED_HOSTS`)
   - Конфигурация Nginx (домены, SSL)
   - Версия кода на сервере
3. **Сравните с локальной версией**:
   - Убедитесь, что локальный `.env` содержит все переменные с сервера
   - Проверьте, что `docker-compose.yml` совместим
   - Убедитесь, что `nginx/nginx.conf` актуален

### Во время деплоя

Используйте собранную информацию для:
- Восстановления переменных окружения, если они потеряются
- Понимания текущей конфигурации перед изменениями
- Отката к предыдущей версии при необходимости

### После деплоя

Сохраните отчет для:
- Документирования production окружения
- Сравнения с будущими деплоями
- Восстановления при проблемах

## Пример использования

```bash
# 1. Сбор информации
./scripts/collect_server_info.sh ~/.ssh/id_rsa root@188.166.240.56

# Вывод:
# Начинаю сбор информации с сервера root@188.166.240.56...
# Проверка подключения к сервере...
# Подключение установлено
# Поиск проекта на сервере...
# Найден проект: /opt/satva-wellness
# Сбор информации о проекте...
# ...
# ✓ Информация успешно собрана!
# Отчет сохранен в: server_info_20260123_143022.md

# 2. Откройте отчет
open server_info_20260123_143022.md

# 3. Проверьте критичные настройки перед деплоем
```

## Устранение проблем

### Ошибка: "Не удалось подключиться к серверу"

**Причины:**
- Неправильный SSH ключ
- Сервер недоступен
- Неправильный адрес сервера

**Решение:**
```bash
# Проверьте подключение вручную
ssh -i ~/.ssh/id_rsa root@188.166.240.56

# Проверьте права на ключ
chmod 600 ~/.ssh/id_rsa
```

### Ошибка: "Permission denied"

**Причины:**
- Недостаточно прав на сервере
- Неправильный пользователь

**Решение:**
- Убедитесь, что используете правильного пользователя (обычно `root`)
- Проверьте права доступа на сервере

### Проект не найден автоматически

**Решение:**
Скрипт попытается использовать текущую директорию. Если проект в нестандартном месте, вы можете:
1. Подключиться к серверу вручную
2. Найти путь к проекту
3. Запустить команды из скрипта вручную

## Безопасность

### Важно

- **Не коммитьте отчеты в git** - они могут содержать чувствительную информацию
- **Удаляйте старые отчеты** - они могут устареть
- **Храните отчеты безопасно** - используйте защищенное хранилище

### Маскировка данных

Скрипт автоматически маскирует:
- Пароли
- Секретные ключи
- Токены

Но все равно будьте осторожны с отчетами!

## Дополнительная документация

- [Подробная инструкция](scripts/SERVER_INFO_COLLECTION.md)
- [Быстрая справка](scripts/README_COLLECT_INFO.md)

## Следующие шаги

После сбора информации:

1. ✅ Проверьте отчет
2. ✅ Сохраните критичные настройки
3. ✅ Сравните с локальной конфигурацией
4. ✅ Создайте бэкап БД перед деплоем
5. ✅ Выполните деплой

---

**Примечание:** Этот скрипт только **читает** информацию с сервера и **не изменяет** ничего. Он безопасен для использования на production сервере.
